---
title: "Cognitive Psychology Seminar - Inhibition"
author: "David I., L. V., L. P., S. R"
date: '`r Sys.Date()`'
output:
  html_document:
    code_folding: show
    highlight: tango
    number_sections: yes
    theme: united
    toc: yes
    toc_float: yes
    df_print: paged
    keep_md: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F, cache = F)
```


```{r packages, include=FALSE }
# Check if packages are installed, if not install and load them

## Make list of required packages 

list.of.packages <- c("dplyr","psych","ggplot2","tidyr","mvnormtest","car","reshape2","tidyverse","afex","lsmeans","ez")

## compare installed and required packages

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]

# installed the not yet installed but required packages and load them

if(length(new.packages)) install.packages(new.packages,dependencies = TRUE)
sapply(list.of.packages, require, character.only = TRUE)
```


Read in data files

```{r,readInData}
data_path <- "./Daten/"
files     <- list.files(data_path)
data      <- list()

for(f in files){
  data[[f]] <- read.table(paste0(data_path,f), stringsAsFactors = FALSE,header=TRUE)
  
  if(f=="StopSignal_1802_bed1_vp13.txt"){
    data[[f]]$vp <- 13
  }
}

inhib <- bind_rows(data)




```


```{r,showHead}
head(inhib)
```

# Participants

```{r,extractDemoVars}

demo <- inhib %>% dplyr::select(.,vp,alt,ges,std)  %>% group_by(.,vp)  %>%   
  summarise(age    = mean(alt, na.rm = T),
            gender = mean(ges, na.rm = T),
            std    = mean(std, na.rm = T)) %>% 
  mutate(., gender.f = factor(gender,label=c("male","female","NA"),levels=c(1,2,9)), 
            std.f    = factor(std,label=c("psychology","erziehungswiss","lehramt","other","NA"),
                       levels = c(1,2,3,4,9)))

```

### Gender

```{r,gender}

      table(demo$gender.f)
      table(demo$gender.f)/nrow(demo)
```

### Age

```{r,age}

      psych::describe(demo$age) %>% knitr::kable(.)
      hist(demo$age)
```

### Course of Study

```{r,cos}

      table(demo$std.f)
      table(demo$std.f)/nrow(demo)
```


# Experiment

## Variable Label and Values

Variable      | Description                 | Values & Labels 
------------- | --------------------------  | ---------------------------------------
vp            | VPN ID                      | Nominal 1-22
alt           | Age                         | Integer 
ges           | Gender                      | Nominal 1 = male; 2=female
std           | Field of Study              | Nominal 1 = psychology; 2 = erziehungsw.; 3 = Lehramt; 4 = other
block         | Block Number                | Nominal 1 = instruction; 2 & 3 = training; 4-6 = testing
trg           | Overall trial number        | Integer
trial         | Trial number                | Integer
stnr          | ?                           | Integer
stim          | stimulus show in trial      | Nominal - even = Dogs, odd = Donuts, 01 = blue square, 02 = orange square
sneu          |  ??                         | ?
kat           | Category of stimulus        | Nominal  0 = square, 1 = donut, 2 = dog
stop          | Stop-trial or not           | Nominal 0 = no, 1 = yes 
ssd           | Stop-signal delay           | Integer 0,100,200 ms 
rgf           | response                    | Nominal 120 = left,right or nothing; Squares 1 = left, 2 = right ; DD  3 = left, 4 = right
resp          | given response              | Nominal 0 = nothing; Squares: 1 = left, 2 = right ; DD:  3 = left, 4 = right
fehl          | error                       | Nominal 0 = no, 1 = yes 
eff           | effect sound                | Nominal 0 = high/no-response sound, 12 = deep/response sound 
krit          | Critical trial or not       | Nominal 0 = no, 1 = yes 
feed          | Wrong or right feedback     | Nominal 0 = no feedback, 1 = right feedback, 2 = wrong feedback
rt            | reaction time               | Integer
verp          | misses                      | Integer 
iti           | true inter trial interval   | Integer  ~ 1100 ms 
ssd           | true Stop-signal delay      | Integer  ~ 0,100,200 ms
datum         | date                        | string 

## Trial informations

```{r}



(inhib %>% dplyr::select(.,-std,-trg,-trial,-stnr,-sneu, -iti,-datum) %>% 
                  mutate(., lag_crit = lag(krit) + 0, lag_feed = lag(feed) + 0) %>% 
                  dplyr::select(.,vp,alt,ges,block,rgf,res,stop,kat,krit,ssd,fehl,lag_feed,lag_crit,rt) %>% 
                  mutate(.,feed.f=factor(lag_feed,levels=c(0,1,2),labels=c("normal","right feedback","wrong feedback")),
                           block.f=factor(block)) %>%
                  group_by(vp,block.f) %>% summarise(., trials = length(res),
                                                        squareTrials = sum(kat==0),
                                                        catTrials = sum(kat!=0),
                                                        criticaltrials = sum(krit==1),
                                                        lagcriticaltrials = sum(lag_crit==1),
                                                        errors = sum(fehl==1),
                                                        stop = sum(stop==1)
                                                        )  
)
  

  

```



## Analysis


First, we delete all variables we don't need anymore.

```{r}
inhib2 <- dplyr::select(inhib,-std,-trg,-trial,-stnr,-sneu,
                       -iti,-datum)
```


Next, I create two new variables, lag_crit and lag_feed, where the entries of the krit and feed variables are shifted by one row, so I have the indication of the feedback type and if it is a critical trial in the same row as the actual trial. Then, I filter only for those trials in the experimental blocks 4-6 were the stimulus was a dog or a donut. At the end, I transform the feedback variable into a factor. 


```{r}
inhib_crit <- inhib2 %>% mutate(., lag_crit = lag(krit) + 0, lag_feed = lag(feed) + 0) %>% 
                   filter(., block == 4 | block == 5 | block == 6, kat == 1 | kat == 2) %>% 
                   dplyr::select(.,vp,alt,ges,block,rgf,res,ssd,fehl,lag_feed,lag_crit,rt) %>% 
                   mutate(.,feed.f=factor(lag_feed,levels=c(0,1,2),
                                          labels=c("normal","right feedback","wrong feedback")),
                            block.f=factor(block))

inhib_crit 
```


### Critical trials, errors and mean & median RT per person


```{r}
inhib_crit %>% group_by(vp) %>% summarise(., trials = length(res),
                                             criticaltrials = sum(lag_crit==1),
                                             errors = sum(fehl==1),
                                             errorrate = errors/trials,
                                             meanRT = mean(rt),
                                             medianRT = median(rt),
                                             diffMeanMedian = meanRT-medianRT)  %>%  knitr::kable(.)

```

There are some people with a high error rate (>10 %) even in this easy task. I will exclude all participants with an error rate > 10 %.

```{r}
inhib_crit <- filter(inhib_crit,vp !=3 & vp != 6 & vp != 18)
```

#### Updated Demographics: 

```{r}
demo <- inhib %>% dplyr::select(.,vp,alt,ges,std) %>% 
        filter(.,vp !=3 & vp != 6 & vp != 18) %>% group_by(.,vp)  %>%   
        summarise(age = mean(alt, na.rm = T),
                  gender = mean(ges, na.rm = T),
                  std = mean(std, na.rm = T)) %>% 
        mutate(., gender.f = factor(gender,label=c("male","female","NA"),levels=c(1,2,9)), 
                  std.f = factor(std,label=c("psychology","erziehungswiss","lehramt","other","NA"),
                            levels=c(1,2,3,4,9)))
  

psych::describe(demo$age) %>% knitr::kable()
table(demo$gender.f)
```



#### Looking at the errors people made: 

```{r}
filter(inhib_crit,fehl==1)
```


There are a lot of errors where people didn't press any button and therefore get an reaction time == 0. Also, error trials tend to be faster. Therefore, I will exclude all trials with errors.

```{r}
inhib_crit <- filter(inhib_crit,fehl==0)
```

Critical trials, errors and mean & median RT per person:

```{r}
inhib_crit %>% group_by(vp) %>% summarise(., trials = length(res),
                                             criticaltrials = sum(lag_crit==1),
                                             errors = sum(fehl==1),
                                             errorrate = errors/criticaltrials,
                                             meanRT = mean(rt),
                                             medianRT = median(rt),
                                             diffMeanMedian = meanRT-medianRT)  %>%  knitr::kable(.)

```

### Within-ANOVA

#### Descriptives

```{r}
temp <- inhib_crit %>% group_by(feed.f) %>%
        dplyr::summarize(.,  meanRT   = mean(rt),
                             medianRT = median(rt),
                             sdRT    = sd(rt)) %>% knitr::kable(.)



```


```{r}


plotDF <- inhib_crit %>% group_by(vp,feed.f) %>% 
  dplyr::summarize(.,  meanRT   = mean(rt))


  ggplot(plotDF, aes(x=meanRT, fill=feed.f)) +
          geom_density(col=NA,alpha=0.4) +
          ggtitle("Distributions of RT (ms)")
  
  
  ggplot(plotDF, aes(y=meanRT, x=feed.f,fill=feed.f)) +
          geom_violin(col=NA,alpha=0.4) +
          ggtitle("Distributions of RT (ms)")

```


#### ANOVA

```{r}



mod <- aov_car(rt ~ feed.f + Error(vp/feed.f),data=inhib_crit)
knitr::kable(nice(mod))

summary(mod)

# get the least square means
referenceGrid <- emmeans(mod, ~ feed.f)

# pairwise comparisons
summary(pairs(referenceGrid, adjust="bonferroni")) %>%  knitr::kable(.)

# With Block as Factor 
mod <- aov_car(rt ~ feed.f + block.f + Error(vp/feed.f+block.f),data=inhib_crit)
knitr::kable(nice(mod))


```


#### Plot 

```{r}
id <- inhib_crit  %>% group_by(.,feed.f) %>%
              dplyr::summarize(., mean    = mean(rt),
                                  se      = sd(rt)/sqrt(length(rt)))


a <- inhib_crit  %>% group_by(.,feed.f,vp) %>%
             dplyr::summarize(., mean    = mean(rt),
                                  se      = sd(rt)/sqrt(length(rt)))


pd <- position_dodge(0.4)


ggplot(id, aes(x=feed.f, y=mean, fill=feed.f)) +
    geom_bar(position=position_dodge(), stat="identity") +
    #scale_fill_manual(values=c("grey80","grey70","grey60")) +
    scale_y_continuous(expand=c(0,0), limits = c(0, 800) ) +
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.2, position=position_dodge(.9))  +
    geom_line(data=a,  aes(x=feed.f, y=mean, group=vp),alpha = .3,lineend = "round",position = pd) +
    geom_point(data=a, aes(x=feed.f, y=mean,group=vp),shape = 21, alpha = .3,position = pd) +
     theme_bw() + theme(legend.position="none") + 
        labs(
          #title = "Hitrate",
          x = "Feedback type",
          y = "RT (ms)",
          color = NULL
        )



ggplot(id, aes(x=feed.f, y=mean,group=1)) +
     geom_smooth(method="loess") +
     geom_point() +
     scale_y_continuous(expand=c(0,0), limits = c(500,650) )  +
     geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.2) + 
    theme_bw() + theme(legend.position="none") + 
          labs(
            #title = "Hitrate",
            x = "Feedback type",
            y = "RT (ms)",
            color = NULL
          )


ggplot(id, aes(x=feed.f, y=mean, group=1)) +
     geom_smooth(method="loess") +
     geom_point() +
     scale_y_continuous(expand=c(0,0), limits = c(480, 720) ) +
     geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.2, height = .2, position=position_dodge(.9))  +
     geom_line(data=a,  aes(x=feed.f, y=mean, group=vp),alpha = .3,lineend = "round",position = pd) +
     geom_point(data=a, aes(x=feed.f, y=mean,group=vp),shape = 21, alpha = .3,position = pd) +
     theme_bw() + theme(legend.position="none") + 
        labs(
          #title = "Hitrate",
          x = "Feedback type",
          y = "RT (ms)",
          color = NULL
        )

ggsave("plotResults.png",dpi=900,width=12,height=6, units = "cm",bg = "transparent")

```







<!-- #### Bayes MLM tryout -->


<!-- ```{r} -->
<!-- library(rethinking) -->
<!-- library(rstan) -->



<!-- temp <- inhib_crit %>% -->
<!--         group_by(vp,feed.f) %>%  -->
<!--         dplyr::summarize(.,  meanRT   = mean(rt)) %>% -->
<!--         mutate(.,feedf_n = as.numeric(feed.f), -->
<!--                feedf=feed.f) %>% -->
<!--         as.data.frame() %>% dplyr::select(.,-feed.f) -->


<!-- str(temp) -->





<!--   mod <- map2stan( -->
<!--     alist( -->
<!--       meanRT ~ dnorm( mu , sigma ), -->

<!--       mu <- a + a_feedf[feedf_n], -->
<!--       a_feedf[feedf_n] ~ dnorm( 0 ,sigma_feed), -->
<!--       a ~ dnorm(0,100), -->
<!--       sigma_feed ~ dcauchy(0,1), -->
<!--       sigma ~ dcauchy(0,1) -->
<!--     ) , -->
<!--   data=temp, warmup=1000 , iter=6000 , chains=1 , cores=3) -->


<!-- precis(mod,depth=2) # depth=2 displays varying effects -->
<!-- plot(precis(mod,depth=2)) # also plot -->



<!-- ``` -->


